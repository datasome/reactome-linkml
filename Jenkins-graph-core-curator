import org.reactome.release.jenkins.utilities.Utilities

// Shared library maintained at 'release-jenkins-utils' repository.
def utils = new Utilities()

pipeline {
	agent any

    environment {
        ECRURL = '851227637779.dkr.ecr.us-east-1.amazonaws.com'
    }
	
	stages {
		stage('pull image') {
            		steps {
		        	script{
				    sh("eval \$(aws ecr get-login --no-include-email --region us-east-1)")
					docker.withRegistry("https://" + ECRURL) {
						docker.image("reactome-schemas:latest").pull()
					}
			    	}
		    	}
        	}

		// This stage generates graph-core-curator classes, validates them against those in feature/graph-core-curator-reformat
		// branch of graph-core-curator, and then generates graphql
		stage('Main: graph-core-curator'){
			steps{
				script{
				    utils.cloneOrUpdateLocalRepo("graph-core-curator")
				    dir("graph-core-curator"){
                        sh "git checkout feature/graph-core-curator-reformat"
                    }
                    // Validate the syntax of schema.yaml
                    sh "gen-json-schema schema.yaml 1> /dev/null 2> err.log; if [ \"$?\" -ne \"0\" ]; then echo \"schema.yaml syntax is not valid: \"`cat err.log`; exit 1; fi"
                    sh "./generate.py java"
                    sh "./compare_java.py curator-graph-core-classes graph-core-curator/src/main/java/org/reactome/server/graph/curator/domain/ > diff.txt"
                    sh "if [ -s diff.txt ]; then echo 'ERROR: The following differences exist between generated and original graph-core-curator classes: '; cat diff.txt; exit 1; fi"
                    sh "./generate.py graphql"
				}
			}
		}
	}
}
